{"componentChunkName":"component---src-components-post-tsx","path":"/node-canvas-aws-lambda","result":{"pageContext":{"post":{"id":"cjeqgftvknnr30199dvw266qh","title":"Installing Node Canvas in AWS Lambda","slug":"node-canvas-aws-lambda","published_at":"2019-12-31T05:00:00","created_at":"2018-03-14T02:16:43","encoded_html":"PHA+IFVzaW5nIG5vZGUtY2FudmFzIG9uIEFXUyBMYW1iZGEgY2FuIGJlIGEgcGFpbiBiZWNhdXNlIG5vZGUtY2FudmFzIGhhcyBkZXBlbmRlbmNpZXMuIEEgc2ltcGxlIHlhcm4gYWRkIG9yIG5wbSBpbnN0YWxsIHdpbGwgbm90IHN1ZmZpY2UuPC9wPgo8aW1nIHNyYz0iaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2NvbnRlbnRraXQvc3RhdGljL2NqZXFnZnR2a25ucjMwMTk5ZHZ3MjY2cWgvYXdzLWxhbWJkYS5qcGciIC8+CjxoMj5ub2RlLWNhbnZhczwvaDI+CjxwPkF1dG9tYXR0aWMncyBub2RlLWNhbnZhcyBleHRlbmRzIHRoZSBmYW1pbGlhciBjYW52YXMgQVBJIGluIHRoZSBicm93c2VyIHRvIE5vZGUuIFdpdGggbm9kZS1jYW52YXMgeW91IGNhbiBkcmF3IHNoYXBlcywgYXBwbHkgdGV4dCBhbmQgb3ZlcmxheSBpbWFnZXMuIFRoZSBkYXRhIHR5cGVzIG5vZGUtY2FudmFzIGludGVyZmFjZXMgd2l0aCBhcmUgaW50ZXJjaGFuZ2VhYmxlLiBGb3IgZXhhbXBsZSwgeW91IGNhbiBhcHBseSB0ZXh0IGFuZCBpbWFnZXMgdG8gYSBjYW52YXMgYW5kIHN0cmVhbSB0aGUgY2FudmFzIFBERiwgcG5nLCBqcGcsIGFycmF5IGJ1ZmZlciwgYW5kIHNvIGZvcnRoLjwvcD4KPGgyPlRoZSBQcm9ibGVtPC9oMj4KPHA+QVdTIExhbWJkYSBpcyBydW5zIG9uIEFtYXpvbidzIHNwZWNpYWwgZmxhdm9yIG9mIGxpbnV4LjwvcD4KPHA+Tm9kZS1jYW52YXMgcmVxdWlyZXMgYSBmZXcgcGFja2FnZXMgbGlrZSBDYWlybyBhbmQgUGFuZ28gdG8gZnVuY3Rpb24uIFRvIGdldCBOb2RlLWNhbnZhcyB1cCBhbmQgcnVubmluZyBvbiBBV1MgbGFtYmRhLCB5b3UgbmVlZCB0byBjb21waWxlIG5hdGl2ZSBsaWJyYXJpZXMgaW4gYW4gaWRlbnRpY2FsIEVDMiBpbnN0YW5jZS4gTmV4dCwgY29weSB0aGUgYmluYXJpZXMgZnJvbSB0aGUgc2VydmVyIHRvIHlvdXIgbG9jYWwgbWFjaGluZSBhbmQgaW5jbHVkZSB0aGVtIGluIHlvdXIgcGFja2FnZSB0aGF0IHlvdSB1cGxvYWQgdG8gQVdTIGxhbWJkYS48L3A+CjxoMj5UaGUgU29sdXRpb248L2gyPgo8cD5UaGUgcXVpY2sgYW5kIGRpcnR5IHNvbHV0aW9uIGlzIHRvIGdpdCBjbG9uZSB0aGlzIHJlcG86IGh0dHBzOi8vZ2l0aHViLmNvbS91bnNoaWZ0L2NhbnZhcy1sYW1iZGEuZ2l0PC9wPgo8cD5UaGUgbGliIGRpcmVjdG9yeSBpbmNsdWRlcyB0aGUgLnNvIGZpbGVzIGFuZCBhIGxhdGVzdCwgcHJlY29tcGlsZWQgdmVyc2lvbiBvZiBjYW52YXMgKHYxLjYuNyAtIHRoZSBsYXRlc3QgYXMgb2YgdGhpcyB3cml0aW5nKS48L3A+CjxwPlRoZSB0cmljayB0byBnZXR0aW5nIEFXUyBsYW1iZGEgdG8gcmVjb2duaXplIHRoZSBwYXRoIHRvIHRoZSBuYXRpdmUgbW9kdWxlcyBpcyB0byBtb2RpZnkgdGhlIGVudmlyb25tZW50YWwgdmFyaWFibGVzIFBBVEgsIExEX0xJQlJBUllfUEFUSCwgUEtHX0NPTkZJR19QQVRILjwvcD4KPHByZT48Y29kZSBjbGFzcz0ibGFuZ3VhZ2UtYmFzaCI+cHJvY2Vzcy5lbnY8c3BhbiBjbGFzcz0idG9rZW4gcHVuY3R1YXRpb24iPls8L3NwYW4+PHNwYW4gY2xhc3M9InRva2VuIHN0cmluZyI+J1BBVEgnPC9zcGFuPjxzcGFuIGNsYXNzPSJ0b2tlbiBwdW5jdHVhdGlvbiI+XTwvc3Bhbj4gPHNwYW4gY2xhc3M9InRva2VuIG9wZXJhdG9yIj49PC9zcGFuPiBwcm9jZXNzLmVudjxzcGFuIGNsYXNzPSJ0b2tlbiBwdW5jdHVhdGlvbiI+Wzwvc3Bhbj48c3BhbiBjbGFzcz0idG9rZW4gc3RyaW5nIj4nUEFUSCc8L3NwYW4+PHNwYW4gY2xhc3M9InRva2VuIHB1bmN0dWF0aW9uIj5dPC9zcGFuPiArIDxzcGFuIGNsYXNzPSJ0b2tlbiBzdHJpbmciPic6Jzwvc3Bhbj4gKyBwcm9jZXNzLmVudjxzcGFuIGNsYXNzPSJ0b2tlbiBwdW5jdHVhdGlvbiI+Wzwvc3Bhbj48c3BhbiBjbGFzcz0idG9rZW4gc3RyaW5nIj4nTEFNQkRBX1RBU0tfUk9PVCc8L3NwYW4+PHNwYW4gY2xhc3M9InRva2VuIHB1bmN0dWF0aW9uIj5dPC9zcGFuPiArIDxzcGFuIGNsYXNzPSJ0b2tlbiBzdHJpbmciPicvbGliJzwvc3Bhbj48c3BhbiBjbGFzcz0idG9rZW4gcHVuY3R1YXRpb24iPjs8L3NwYW4+CnByb2Nlc3MuZW52PHNwYW4gY2xhc3M9InRva2VuIHB1bmN0dWF0aW9uIj5bPC9zcGFuPjxzcGFuIGNsYXNzPSJ0b2tlbiBzdHJpbmciPidMRF9MSUJSQVJZX1BBVEgnPC9zcGFuPjxzcGFuIGNsYXNzPSJ0b2tlbiBwdW5jdHVhdGlvbiI+XTwvc3Bhbj4gPHNwYW4gY2xhc3M9InRva2VuIG9wZXJhdG9yIj49PC9zcGFuPiBwcm9jZXNzLmVudjxzcGFuIGNsYXNzPSJ0b2tlbiBwdW5jdHVhdGlvbiI+Wzwvc3Bhbj48c3BhbiBjbGFzcz0idG9rZW4gc3RyaW5nIj4nTEFNQkRBX1RBU0tfUk9PVCc8L3NwYW4+PHNwYW4gY2xhc3M9InRva2VuIHB1bmN0dWF0aW9uIj5dPC9zcGFuPiArIDxzcGFuIGNsYXNzPSJ0b2tlbiBzdHJpbmciPicvbGliJzwvc3Bhbj48c3BhbiBjbGFzcz0idG9rZW4gcHVuY3R1YXRpb24iPjs8L3NwYW4+CnByb2Nlc3MuZW52PHNwYW4gY2xhc3M9InRva2VuIHB1bmN0dWF0aW9uIj5bPC9zcGFuPjxzcGFuIGNsYXNzPSJ0b2tlbiBzdHJpbmciPidQS0dfQ09ORklHX1BBVEgnPC9zcGFuPjxzcGFuIGNsYXNzPSJ0b2tlbiBwdW5jdHVhdGlvbiI+XTwvc3Bhbj4gPHNwYW4gY2xhc3M9InRva2VuIG9wZXJhdG9yIj49PC9zcGFuPiBwcm9jZXNzLmVudjxzcGFuIGNsYXNzPSJ0b2tlbiBwdW5jdHVhdGlvbiI+Wzwvc3Bhbj48c3BhbiBjbGFzcz0idG9rZW4gc3RyaW5nIj4nTEFNQkRBX1RBU0tfUk9PVCc8L3NwYW4+PHNwYW4gY2xhc3M9InRva2VuIHB1bmN0dWF0aW9uIj5dPC9zcGFuPiArIDxzcGFuIGNsYXNzPSJ0b2tlbiBzdHJpbmciPicvbGliJzwvc3Bhbj48c3BhbiBjbGFzcz0idG9rZW4gcHVuY3R1YXRpb24iPjs8L3NwYW4+PC9jb2RlPjwvcHJlPgo8cD5OZXh0LCBkcm9wIHRoZSBiaW5hcmllcyBpbiB0aGUgbGliIGRpcmVjdG9yeSBvZiB0aGUgcm9vdCBvZiB5b3VyIGxhbWJkYSBmdW5jdGlvbiwgZS5nLjo8L3A+Cjx1bD4KICA8bGk+aGFuZGxlci5qczwvbGk+CiAgPGxpPm5vZGVfbW9kdWxlczwvbGk+CiAgPGxpPmxpYjwvbGk+CiAgPGxpPnBhY2thZ2UuanNvbjwvbGk+CjwvdWw+CjxoMj5QcmUtQ29tcGlsaW5nIG5vZGUtY2FudmFzIG9uIEVDMjwvaDI+CjxwPlVzZSB0aGlzIGJhc2ggc2NyaXB0IHRvIGluc3RhbGwgZGVwZW5kZW5jaWVzOiBodHRwczovL2dpc3QuZ2l0aHViLmNvbS91bnNoaWZ0L2NkZWJkOWExZGE5ODgxNjUxNDc4OWI2MmNiZTc3OTdkPC9wPgo8cD5pbnN0YWxsX25vZGVfY2FudmFzX2JpbmFyaWVzLnNoIGluc3RhbGxzIHRoZSBmb2xsb3dpbmcgYXQgL2NhbnZhcy86PC9wPgo8dWw+CiAgPGxpPmxpYnBuZzwvbGk+CiAgPGxpPmpwZWdzcmM8L2xpPgogIDxsaT5waXhtYW48L2xpPgogIDxsaT5mcmVldHlwZTwvbGk+CiAgPGxpPmNhaXJvPC9saT4KICA8bGk+Z2lmbGliPC9saT4KICA8bGk+bGlieG1sMjwvbGk+CiAgPGxpPmZvbnRjb25maWc8L2xpPgo8L3VsPgo8cD5OZXh0IGl0IGNvcGllcyB0aGUgbmF0aXZlIG1vZHVsZXMgdG8gL3Zhci90YXNrL2xpYi48L3A+CjxwPi92YXIvdGFzayBpcyB3aGVyZSBMYW1iZGEgZnVuY3Rpb25zIGxpdmUuPC9wPgo8cD5UaGUgbGFzdCBzdGVwIGlzIHRvIG5wbSBpbnN0YWxsIGNhbnZhcyAoZGlzY3Vzc2VkIGJlbG93KS48L3A+CjxoMz5FQzIgU2V0dXA8L2gzPgo8dWw+CiAgPGxpPlNwaW4gdXAgYW4gRUMyIGluc3RhbmNlIHVzaW5nIHRoZSBsYXRlc3QgQW1hem9uIE1hY2hpbmUgSW1hZ2UgKGh0dHA6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvY3VycmVudC1zdXBwb3J0ZWQtdmVyc2lvbnMuaHRtbCk8L2xpPgogIDxsaT5TU0ggaW50byB0aGUgYm94LjwvbGk+CiAgPGxpPllvdSBjYW4gc3dpdGNoIHRvIHJvb3QgYnkgaXNzdWluZyB0aGUgY29tbWFuZCA8Y29kZT5zdWRvIHN1IC0uPC9jb2RlPjwvbGk+CiAgPGxpPkluc3RhbGwgbm9kZTogPGNvZGU+c3VkbyB5dW0gaW5zdGFsbCBub2RlanMgbnBtIC0tZW5hYmxlcmVwbz1lcGVsPC9jb2RlPjwvbGk+CjwvdWw+CjxoMj5SdW4gdGhlIHNjcmlwdDwvaDI+CjxwcmU+PGNvZGUgY2xhc3M9Imxhbmd1YWdlLWJhc2giPjxzcGFuIGNsYXNzPSJ0b2tlbiBidWlsdGluIGNsYXNzLW5hbWUiPmNkPC9zcGFuPiAvdG1wCjxzcGFuIGNsYXNzPSJ0b2tlbiBmdW5jdGlvbiI+d2dldDwvc3Bhbj4gaHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS91bnNoaWZ0L2NkZWJkOWExZGE5ODgxNjUxNDc4OWI2MmNiZTc3OTdkL3Jhdy81N2ExMTE5NWJiNmFiOWFhZTEzZGM0Zjk3ZWVjOGNlMmIwYjVhNzcxL2luc3RhbGxfbm9kZV9jYW52YXNfYmluYXJpZXMuc2gKPHNwYW4gY2xhc3M9InRva2VuIGZ1bmN0aW9uIj5zaDwvc3Bhbj4gaW5zdGFsbF9ub2RlX2NhbnZhc19iaW5hcmllcy5zaAo8c3BhbiBjbGFzcz0idG9rZW4gYnVpbHRpbiBjbGFzcy1uYW1lIj5jZDwvc3Bhbj4gL3Zhci90YXNrL2xpYgo8c3BhbiBjbGFzcz0idG9rZW4gZnVuY3Rpb24iPm5wbTwvc3Bhbj4gPHNwYW4gY2xhc3M9InRva2VuIGZ1bmN0aW9uIj5pbnN0YWxsPC9zcGFuPiBjYW52YXMKPHNwYW4gY2xhc3M9InRva2VuIGJ1aWx0aW4gY2xhc3MtbmFtZSI+Y2Q8L3NwYW4+IG5vZGVfbW9kdWxlcy9jYW52YXMKbm9kZS1neXAgcmVidWlsZDwvY29kZT48L3ByZT4KPGgyPkZ1cnRoZXIgUmVhZGluZzwvaDI+Cjx1bD4KICA8bGk+PGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL0F1dG9tYXR0aWMvbm9kZS1jYW52YXMvd2lraS9JbnN0YWxsYXRpb24tLS1BbWF6b24tTGludXgtQU1JLShFQzIpIj5odHRwczovL2dpdGh1Yi5jb20vQXV0b21hdHRpYy9ub2RlLWNhbnZhcy93aWtpL0luc3RhbGxhdGlvbi0tLUFtYXpvbi1MaW51eC1BTUktKEVDMik8L2E+PC9saT4KICA8bGk+PGEgaHJlZj0iaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzM5Mjk4NzAvbm9kZS1jYW52YXMtYnVpbGQtZm9yLWF3cy1sYW1iZGEiPmh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzMzOTI5ODcwL25vZGUtY2FudmFzLWJ1aWxkLWZvci1hd3MtbGFtYmRhPC9hPjwvbGk+CiAgPGxpPjxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9uYXZpaHRvdC9ub2RlLWNhbWFuLWF3cy1sYW1iZGEvYmxvYi9tYXN0ZXIvaG93LXRvLm1kIj5odHRwczovL2dpdGh1Yi5jb20vbmF2aWh0b3Qvbm9kZS1jYW1hbi1hd3MtbGFtYmRhL2Jsb2IvbWFzdGVyL2hvdy10by5tZDwvYT48L2xpPgo8L3VsPg==","excerpt":" Using node-canvas on AWS Lambda can be a pain because node-canvas has dependencies. A simple yarn ","image":{"id":"cjfwjtmf1177g01692ug3tzwl","url":"static/cjeqgftvknnr30199dvw266qh/aws-lambda.jpg"},"posts_tags":[{"tag":{"id":"3pl7ejawubufz70vjnad","name":"AWS"}},{"tag":{"id":"2spo553zykbgxgq4vkk3","name":"Javascript"}}],"date":"12/31/2019","html":"<p> Using node-canvas on AWS Lambda can be a pain because node-canvas has dependencies. A simple yarn add or npm install will not suffice.</p>\n<img src=\"https://s3.amazonaws.com/contentkit/static/cjeqgftvknnr30199dvw266qh/aws-lambda.jpg\" />\n<h2>node-canvas</h2>\n<p>Automattic's node-canvas extends the familiar canvas API in the browser to Node. With node-canvas you can draw shapes, apply text and overlay images. The data types node-canvas interfaces with are interchangeable. For example, you can apply text and images to a canvas and stream the canvas PDF, png, jpg, array buffer, and so forth.</p>\n<h2>The Problem</h2>\n<p>AWS Lambda is runs on Amazon's special flavor of linux.</p>\n<p>Node-canvas requires a few packages like Cairo and Pango to function. To get Node-canvas up and running on AWS lambda, you need to compile native libraries in an identical EC2 instance. Next, copy the binaries from the server to your local machine and include them in your package that you upload to AWS lambda.</p>\n<h2>The Solution</h2>\n<p>The quick and dirty solution is to git clone this repo: https://github.com/unshift/canvas-lambda.git</p>\n<p>The lib directory includes the .so files and a latest, precompiled version of canvas (v1.6.7 - the latest as of this writing).</p>\n<p>The trick to getting AWS lambda to recognize the path to the native modules is to modify the environmental variables PATH, LD_LIBRARY_PATH, PKG_CONFIG_PATH.</p>\n<pre><code class=\"language-bash\">process.env<span class=\"token punctuation\">[</span><span class=\"token string\">'PATH'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> process.env<span class=\"token punctuation\">[</span><span class=\"token string\">'PATH'</span><span class=\"token punctuation\">]</span> + <span class=\"token string\">':'</span> + process.env<span class=\"token punctuation\">[</span><span class=\"token string\">'LAMBDA_TASK_ROOT'</span><span class=\"token punctuation\">]</span> + <span class=\"token string\">'/lib'</span><span class=\"token punctuation\">;</span>\nprocess.env<span class=\"token punctuation\">[</span><span class=\"token string\">'LD_LIBRARY_PATH'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> process.env<span class=\"token punctuation\">[</span><span class=\"token string\">'LAMBDA_TASK_ROOT'</span><span class=\"token punctuation\">]</span> + <span class=\"token string\">'/lib'</span><span class=\"token punctuation\">;</span>\nprocess.env<span class=\"token punctuation\">[</span><span class=\"token string\">'PKG_CONFIG_PATH'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> process.env<span class=\"token punctuation\">[</span><span class=\"token string\">'LAMBDA_TASK_ROOT'</span><span class=\"token punctuation\">]</span> + <span class=\"token string\">'/lib'</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Next, drop the binaries in the lib directory of the root of your lambda function, e.g.:</p>\n<ul>\n  <li>handler.js</li>\n  <li>node_modules</li>\n  <li>lib</li>\n  <li>package.json</li>\n</ul>\n<h2>Pre-Compiling node-canvas on EC2</h2>\n<p>Use this bash script to install dependencies: https://gist.github.com/unshift/cdebd9a1da98816514789b62cbe7797d</p>\n<p>install_node_canvas_binaries.sh installs the following at /canvas/:</p>\n<ul>\n  <li>libpng</li>\n  <li>jpegsrc</li>\n  <li>pixman</li>\n  <li>freetype</li>\n  <li>cairo</li>\n  <li>giflib</li>\n  <li>libxml2</li>\n  <li>fontconfig</li>\n</ul>\n<p>Next it copies the native modules to /var/task/lib.</p>\n<p>/var/task is where Lambda functions live.</p>\n<p>The last step is to npm install canvas (discussed below).</p>\n<h3>EC2 Setup</h3>\n<ul>\n  <li>Spin up an EC2 instance using the latest Amazon Machine Image (http://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html)</li>\n  <li>SSH into the box.</li>\n  <li>You can switch to root by issuing the command <code>sudo su -.</code></li>\n  <li>Install node: <code>sudo yum install nodejs npm --enablerepo=epel</code></li>\n</ul>\n<h2>Run the script</h2>\n<pre><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> /tmp\n<span class=\"token function\">wget</span> https://gist.githubusercontent.com/unshift/cdebd9a1da98816514789b62cbe7797d/raw/57a11195bb6ab9aae13dc4f97eec8ce2b0b5a771/install_node_canvas_binaries.sh\n<span class=\"token function\">sh</span> install_node_canvas_binaries.sh\n<span class=\"token builtin class-name\">cd</span> /var/task/lib\n<span class=\"token function\">npm</span> <span class=\"token function\">install</span> canvas\n<span class=\"token builtin class-name\">cd</span> node_modules/canvas\nnode-gyp rebuild</code></pre>\n<h2>Further Reading</h2>\n<ul>\n  <li><a href=\"https://github.com/Automattic/node-canvas/wiki/Installation---Amazon-Linux-AMI-(EC2)\">https://github.com/Automattic/node-canvas/wiki/Installation---Amazon-Linux-AMI-(EC2)</a></li>\n  <li><a href=\"https://stackoverflow.com/questions/33929870/node-canvas-build-for-aws-lambda\">https://stackoverflow.com/questions/33929870/node-canvas-build-for-aws-lambda</a></li>\n  <li><a href=\"https://github.com/navihtot/node-caman-aws-lambda/blob/master/how-to.md\">https://github.com/navihtot/node-caman-aws-lambda/blob/master/how-to.md</a></li>\n</ul>"}}}}